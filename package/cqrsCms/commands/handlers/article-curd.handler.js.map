{"version":3,"sources":["cqrsCms/commands/handlers/article-curd.handler.ts"],"names":[],"mappings":"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","file":"article-curd.handler.js","sourcesContent":["import { CommandHandler, EventPublisher, ICommandHandler } from \"@nestjs/cqrs\";\nimport { PageRepository } from \"../../repository/pageRepository\";\nimport { ArticleService } from \"../../service/article.service\";\nimport { ClassifyService } from \"../../service/classify.service\";\nimport { ArticleParamCommand } from \"../impl/article-param.command\";\n\n@CommandHandler(ArticleParamCommand)\nexport class ArticleCurdHandler implements ICommandHandler<ArticleParamCommand> {\n    constructor(\n        private readonly repositoty: PageRepository,\n        private readonly publisher: EventPublisher,\n        private readonly articleService: ArticleService,\n        private readonly classifyService: ClassifyService,\n    ) {\n    }\n\n    async execute(command: ArticleParamCommand, resolver: (value) => void): Promise<any> {\n        const id = \"0\";\n        const page = this.publisher.mergeObjectContext(await this.repositoty.find(id));\n        let result;\n        /*增删改需要重新写*/\n        if (!command.article.getAllArticles) {\n            let value, messageCodeError;\n            /*增加、修改、删除、文章*/\n            if (command.article.createArticle) {\n                const result = await this.articleService\n                    .CurdArticleCheck(\n                        command.article.createArticle.article.classifyId,\n                        0,\n                    );\n                value = result.Continue;\n                messageCodeError = result.MessageCodeError;\n            }\n            if (command.article.updateArticle) {\n                const result = await this.articleService\n                    .CurdArticleCheck(\n                        command.article.updateArticle.article.classifyId,\n                        command.article.updateArticle.article.id,\n                    );\n                value = result.Continue;\n                messageCodeError = result.MessageCodeError;\n            }\n            if (command.article.pictureUpload) {\n                const result = await this.articleService.upLoadPicture(command.article.pictureUpload.url,\n                    command.article.pictureUpload.bucketName,\n                    command.article.pictureUpload.rawName,\n                    command.article.pictureUpload.base64,\n                    command.article.pictureUpload.id);\n                value = false;\n                resolver(result);\n            }\n            if (value === undefined) { value = true; }\n            if (value) { page.createArticle(command.article); }\n            resolver({ MessageCodeError: messageCodeError, Continue: value });\n        }\n        /*分页获取全部文章：可以选择是否隐藏*/\n        if (command.article.getAllArticles && command.article.getArticles.getArticleAll) {\n            result = await this.articleService.getArticleAll(command.article.limitNum, command.article.getArticles.hidden, command.article.pages);\n        }\n        /*根据id获取单独页面*/\n        if (command.article.getAllArticles && command.article.getArticles.getArticleById) {\n            result = await this.articleService.getArticleById(command.article.getArticles.getArticleById);\n        }\n\n        /*回收站获取文章*/\n        if (command.article.getAllArticles && command.article.getArticles.recycleFind) {\n            result = await this.articleService.recycleFind(command.article.limitNum, command.article.pages).then(a => {\n                return a;\n            });\n        }\n        /*回收站内根据分类id获取文章*/\n        if (command.article.getAllArticles && command.article.getArticles.reductionGetByClassifyId) {\n            result = await this.articleService.reductionClassity(command.article.getArticles.reductionGetByClassifyId,\n                command.article.limitNum, command.article.pages);\n        }\n        /*页面内根据分类id获取文章，可以选择是否包含置顶文章*/\n        if (command.article.getAllArticles && command.article.getArticles.getArticleByClassifyId) {\n            result = await this.classifyService.getArticelsByClassifyId(\n                command.article.getArticles.getArticleByClassifyId.classifyId,\n                command.article.limitNum,\n                command.article.getArticles.getArticleByClassifyId.top,\n                command.article.pages,\n                command.article.getArticles.getArticleByClassifyId.name);\n        }\n        /*获取置顶文章*/\n        if (command.article.getAllArticles && command.article.getArticles.findTopPlace) {\n            result = await this.articleService.findTopPlace(command.article.limitNum, command.article.pages);\n        }\n        /*显示子级分类文章*/\n        if (command.article.getAllArticles && command.article.getArticles.showNext) {\n            result = await this.classifyService.showNextTitle(command.article.getArticles.showNext);\n        }\n        /*显示上级分类文章以及置顶到上级的文章*/\n        if (command.article.getAllArticles && command.article.getArticles.superiorArticle) {\n            result = await this.classifyService.showBeforeTitle(command.article.getArticles.superiorArticle);\n        }\n        /*显示当前分类文章*/\n        if (command.article.getAllArticles && command.article.getArticles.getCurrentClassifyArticles) {\n            result = await this.classifyService.showCurrentArticles(command.article.getArticles.getCurrentClassifyArticles);\n        }\n        /*关键字搜索活动和资讯*/\n        if (command.article.getArticles && command.article.getArticles.keywordSearch) {\n            result = await this.articleService.searchArticles(\n                command.article.getArticles.keywordSearch.keywords,\n                command.article.limitNum,\n                command.article.pages);\n        }\n        /*显示分类层级 暂未确定是否开放*/\n        /*  if(command.article.getAllArticles && command.article.getArticles.getLevelByClassifyId){\n              result=await this.articleService.getLevelByClassifyId(command.article.getArticles.getLevelByClassifyId);\n          }*/\n        resolver(result);\n        page.commit();\n\n    }\n}\n"]}